<!DOCTYPE html>
<html lang="ja">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>YomiToku OCR Control Room</title>
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet" />
		<style>
			:root {
				--bg: #f8fafc;
				--panel: #ffffff;
				--muted: #64748b;
				--accent: #0369a1;
				--accent-light: #e0f2fe;
				--text: #1e293b;
				--text-secondary: #475569;
				--border: #e2e8f0;
				--border-focus: #0369a1;
				--success: #059669;
				--success-bg: #ecfdf5;
				--warning: #d97706;
				--warning-bg: #fffbeb;
				--error: #dc2626;
				--shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
				--shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
				--shadow-md: 0 4px 6px rgba(0, 0, 0, 0.07), 0 2px 4px rgba(0, 0, 0, 0.05);
				--radius: 8px;
				--radius-lg: 12px;
			}

			* {
				box-sizing: border-box;
			}

			body {
				margin: 0;
				padding: 0;
				background: var(--bg);
				font-family: "Noto Sans JP", -apple-system, BlinkMacSystemFont, sans-serif;
				color: var(--text);
				min-height: 100vh;
				height: 100vh;
				overflow: hidden;
				font-size: 14px;
				line-height: 1.6;
			}

			.shell {
				width: 100%;
				max-width: none;
				margin: 0;
				padding: 16px 20px 20px;
				min-height: 100vh;
				display: flex;
				flex-direction: column;
				gap: 14px;
			}

			.hero {
				display: flex;
				align-items: center;
				justify-content: space-between;
				gap: 24px;
				flex-wrap: wrap;
			}

			.hero-card {
				flex-shrink: 0;
			}

			.eyebrow {
				display: inline-block;
				font-size: 11px;
				font-weight: 600;
				color: var(--accent);
				text-transform: uppercase;
				letter-spacing: 0.08em;
				margin: 0 0 4px 0;
			}

			h1 {
				margin: 0 0 8px 0;
				font-size: 20px;
				font-weight: 600;
				color: var(--text);
				letter-spacing: -0.01em;
			}

			.status-row {
				display: flex;
				gap: 8px;
				flex-wrap: wrap;
			}

			.chip {
				padding: 4px 10px;
				border-radius: 999px;
				background: var(--bg);
				border: 1px solid var(--border);
				font-size: 12px;
				font-weight: 500;
				color: var(--text-secondary);
				font-family: "IBM Plex Mono", monospace;
			}

			.chip.positive {
				background: var(--success-bg);
				border-color: #a7f3d0;
				color: var(--success);
			}

			.chip.warning {
				background: var(--warning-bg);
				border-color: #fde68a;
				color: var(--warning);
			}

			.grid {
				display: grid;
				grid-template-columns: 1fr 1.2fr;
				gap: 16px;
				align-items: stretch;
				flex: 1;
				min-height: 0;
			}

			.grid > .panel {
				height: 100%;
				min-height: 200px;
				display: flex;
				flex-direction: column;
			}

			@media (max-width: 1100px) {
				.grid {
					grid-template-columns: 1fr;
				}
			}

			.panel {
				background: var(--panel);
				border: 1px solid var(--border);
				border-radius: var(--radius-lg);
				padding: 14px 16px;
				box-shadow: var(--shadow);
				min-width: 0;
				overflow: hidden;
				display: flex;
				flex-direction: column;
			}

			.scrollable {
				overflow-y: auto;
				min-height: 0;
				flex: 1;
			}

			.action-card {
				background: var(--panel);
				border: 1px solid var(--border);
				border-radius: var(--radius-lg);
				padding: 12px 16px;
				box-shadow: var(--shadow);
				display: flex;
				align-items: center;
				gap: 16px;
				flex-wrap: wrap;
			}

			.panel h2 {
				margin: 0 0 10px 0;
				font-size: 14px;
				font-weight: 600;
				color: var(--text);
				display: flex;
				align-items: center;
				gap: 8px;
				flex-shrink: 0;
			}

			.panel h2::before {
				content: "";
				width: 3px;
				height: 14px;
				background: var(--accent);
				border-radius: 2px;
			}

			.dropzone {
				border: 2px dashed var(--border);
				border-radius: var(--radius);
				padding: 10px 20px;
				display: flex;
				align-items: center;
				justify-content: center;
				text-align: center;
				color: var(--muted);
				background: var(--bg);
				cursor: pointer;
				transition: border-color 0.15s, background 0.15s;
				gap: 10px;
				white-space: nowrap;
			}

			.dropzone:hover {
				border-color: var(--accent);
				background: var(--accent-light);
			}

			.dropzone.dragover {
				border-color: var(--accent);
				background: var(--accent-light);
			}

			.dropzone-icon {
				width: 20px;
				height: 20px;
				stroke: var(--muted);
				stroke-width: 1.5;
				flex-shrink: 0;
			}

			.dropzone:hover .dropzone-icon,
			.dropzone.dragover .dropzone-icon {
				stroke: var(--accent);
			}

			.dropzone-text {
				font-size: 13px;
				font-weight: 500;
				color: var(--text-secondary);
			}

			.dropzone-hint {
				display: none;
			}

			.inline-controls {
				display: flex;
				gap: 12px;
				flex-wrap: wrap;
				align-items: center;
			}

			.inline-controls label {
				display: flex;
				align-items: center;
				gap: 5px;
				margin: 0;
				color: var(--text-secondary);
				font-size: 13px;
				cursor: pointer;
				white-space: nowrap;
			}

			.inline-controls input[type="checkbox"] {
				width: 16px;
				height: 16px;
				accent-color: var(--accent);
				cursor: pointer;
			}

			button[type="submit"] {
				padding: 9px 24px;
				background: var(--accent);
				color: #fff;
				border: none;
				border-radius: var(--radius);
				font-size: 14px;
				font-weight: 600;
				cursor: pointer;
				transition: background 0.15s;
				white-space: nowrap;
				flex-shrink: 0;
			}

			button[type="submit"]:hover {
				background: #0284c7;
			}

			button[type="submit"]:active {
				background: #0369a1;
			}

			button[type="submit"]:disabled {
				opacity: 0.6;
				cursor: not-allowed;
			}

			.log {
				font-size: 12px;
				font-family: "IBM Plex Mono", monospace;
				color: var(--muted);
				padding: 4px 8px;
				background: var(--bg);
				border-radius: 4px;
				max-width: 200px;
				overflow: hidden;
				text-overflow: ellipsis;
				white-space: nowrap;
			}

			.log:empty {
				display: none;
			}

			.result-card {
				border: 1px solid var(--border);
				border-radius: var(--radius);
				padding: 14px;
				background: var(--bg);
			}

			.result-card + .result-card {
				margin-top: 12px;
			}

			.result-card h3 {
				margin: 0 0 10px 0;
				font-size: 14px;
				font-weight: 600;
				color: var(--text);
			}

			.result-card pre {
				background: #fff;
				border: 1px solid var(--border);
				border-radius: var(--radius);
				padding: 12px;
				white-space: pre-wrap;
				line-height: 1.7;
				color: var(--text);
				font-family: "IBM Plex Mono", monospace;
				font-size: 12px;
				max-height: 260px;
				overflow: auto;
				margin: 0;
			}

			.preview-row {
				display: flex;
				flex-wrap: wrap;
				gap: 10px;
				margin-top: 12px;
			}

			.preview-row img {
				border-radius: var(--radius);
				border: 1px solid var(--border);
				max-width: 48%;
				width: 300px;
				object-fit: cover;
				background: #fff;
				cursor: zoom-in;
				transition: box-shadow 0.15s;
			}

			.preview-row img:hover {
				box-shadow: var(--shadow-md);
			}

			.block-list {
				display: grid;
				grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
				gap: 8px;
				margin-top: 10px;
			}

			.block-item {
				padding: 10px;
				border-radius: var(--radius);
				border: 1px solid var(--border);
				background: #fff;
				font-size: 12px;
				display: flex;
				gap: 10px;
				align-items: flex-start;
				cursor: pointer;
				transition: border-color 0.15s;
			}

			.block-item:hover {
				border-color: var(--accent);
			}

			.block-item input[type="checkbox"] {
				width: 14px;
				height: 14px;
				accent-color: var(--error);
				cursor: pointer;
				flex-shrink: 0;
				margin-top: 2px;
			}

			.block-meta {
				color: var(--muted);
				font-size: 11px;
				margin-top: 2px;
				line-height: 1.5;
			}

			.tabs {
				display: flex;
				gap: 4px;
				margin: 6px 0 12px;
				flex-wrap: nowrap;
				overflow-x: auto;
				padding-bottom: 4px;
			}

			.tab {
				padding: 6px 12px;
				border-radius: var(--radius);
				border: 1px solid var(--border);
				background: #fff;
				color: var(--text-secondary);
				cursor: pointer;
				font-size: 12px;
				font-weight: 500;
				white-space: nowrap;
				transition: all 0.15s;
			}

			.tab:hover {
				border-color: var(--accent);
				color: var(--accent);
			}

			.tab.active {
				background: var(--accent);
				color: #fff;
				border-color: var(--accent);
			}

			.tab-panels {
				position: relative;
				overflow: hidden;
			}

			.tab-panel {
				display: none;
			}

			.tab-panel.active {
				display: block;
			}

			.badge-row {
				display: flex;
				gap: 6px;
				flex-wrap: wrap;
				margin-bottom: 10px;
			}

			.muted {
				color: var(--muted);
			}

			.empty-state {
				display: flex;
				flex-direction: column;
				align-items: center;
				justify-content: center;
				padding: 40px 16px;
				text-align: center;
				color: var(--muted);
				gap: 8px;
				flex: 1;
			}

			.empty-icon {
				width: 36px;
				height: 36px;
				stroke: var(--border);
				stroke-width: 1.5;
			}

			.empty-state span {
				font-size: 13px;
			}

			.lightbox {
				position: fixed;
				inset: 0;
				background: rgba(0, 0, 0, 0.8);
				display: none;
				align-items: center;
				justify-content: center;
				padding: 20px;
				z-index: 100;
				cursor: zoom-out;
			}

			.lightbox.open {
				display: flex;
			}

			.lightbox img {
				max-width: 90vw;
				max-height: 90vh;
				border-radius: var(--radius);
				background: #fff;
				box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
			}

			@media (max-width: 768px) {
				.shell {
					padding: 16px;
				}
				
				h1 {
					font-size: 18px;
				}
				
				.action-card {
					padding: 16px;
				}
			}
		</style>
	</head>
	<body>
		<div class="shell">
			<div class="hero">
				<div class="hero-card">
					<p class="eyebrow">YomiToku Control Room</p>
					<h1>High-Precision OCR Server</h1>
					<div class="status-row">
						<span id="gpuStatus" class="chip">GPU: チェック中</span>
						<span class="chip positive">LAN Ready</span>
						<span class="chip">Parallel Control</span>
					</div>
				</div>
				<form id="controlForm" class="action-card">
						<label for="fileInput" class="dropzone" id="dropzone">
							<svg class="dropzone-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
								<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" stroke-linecap="round" stroke-linejoin="round"/>
								<polyline points="17,8 12,3 7,8" stroke-linecap="round" stroke-linejoin="round"/>
								<line x1="12" y1="3" x2="12" y2="15" stroke-linecap="round" stroke-linejoin="round"/>
							</svg>
							<span class="dropzone-text">ファイルを選択</span>
							<input id="fileInput" type="file" accept="image/*,.pdf" required style="display: none" />
						</label>
						<div class="log" id="log"></div>
						<div class="inline-controls">
							<label>
								<input type="checkbox" id="visualize" checked />
								<span>可視化</span>
							</label>
							<label>
								<input type="checkbox" id="collapseBreaks" />
								<span>改行削除</span>
							</label>
						</div>
						<button type="submit" id="runButton">OCR 実行</button>
					</form>
			</div>

			<div class="grid">
				<div class="panel all-panel scrollable">
					<h2>All Pages</h2>
					<div id="summaryEmpty" class="empty-state">
						<svg class="empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
							<rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
							<line x1="3" y1="9" x2="21" y2="9"/>
							<line x1="9" y1="21" x2="9" y2="9"/>
						</svg>
						<span>ファイルをアップロードして解析を開始</span>
					</div>
					<div id="summary" class="badge-row"></div>
					<div class="result-card" id="allTextCard" style="display: none">
						<h3>結合テキスト</h3>
						<p class="muted" style="margin: 2px 0 8px; font-size: 12px;">
							除外設定はページ別のチェック状態に連動します。
						</p>
						<pre id="text-all">未取得</pre>
					</div>
				</div>

				<div class="panel results-panel scrollable">
					<h2>ページ別</h2>
					<div id="pageEmpty" class="empty-state">
						<svg class="empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
							<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
							<polyline points="14,2 14,8 20,8"/>
							<line x1="16" y1="13" x2="8" y2="13"/>
							<line x1="16" y1="17" x2="8" y2="17"/>
						</svg>
						<span>ファイルをアップロードして解析を開始</span>
					</div>
					<div class="tabs" id="pageTabs"></div>
					<div class="tab-panels" id="pagePanels"></div>
				</div>
			</div>

			<div id="lightbox" class="lightbox" aria-hidden="true">
				<img id="lightboxImg" alt="Preview" />
			</div>
		</div>

		<script>
			const form = document.getElementById("controlForm");
			const logEl = document.getElementById("log");
			const gpuStatus = document.getElementById("gpuStatus");
			const runButton = document.getElementById("runButton");
			const summaryEl = document.getElementById("summary");
			const summaryEmpty = document.getElementById("summaryEmpty");
			const allTextCard = document.getElementById("allTextCard");
			const textAllEl = document.getElementById("text-all");
			const pageTabsEl = document.getElementById("pageTabs");
			const pagePanelsEl = document.getElementById("pagePanels");
			const pageEmpty = document.getElementById("pageEmpty");
			const collapseBreaksInput = document.getElementById("collapseBreaks");
			const lightbox = document.getElementById("lightbox");
			const lightboxImg = document.getElementById("lightboxImg");
			const dropzone = document.getElementById("dropzone");
			const fileInput = document.getElementById("fileInput");

			async function refreshStatus() {
				try {
					const res = await fetch("/api/status");
					const data = await res.json();
					const gpu = data.cuda_available ? "利用可" : "CPU のみ";
					gpuStatus.textContent = `GPU: ${gpu}`;
					gpuStatus.className = `chip ${data.cuda_available ? "positive" : "warning"}`;
				} catch (err) {
					gpuStatus.textContent = "GPU: 不明";
					gpuStatus.className = "chip warning";
				}
			}

			function setBusy(isBusy, message = "") {
				runButton.disabled = isBusy;
				runButton.textContent = isBusy ? "実行中..." : "OCR 実行";
				if (message) {
					logEl.textContent = message;
				}
			}

			function resetResults(message = "ファイルをアップロードして解析を開始") {
				currentPayload = null;
				summaryEl.innerHTML = "";
				summaryEmpty.querySelector("span").textContent = message;
				summaryEmpty.style.display = "flex";
				allTextCard.style.display = "none";
				textAllEl.textContent = "";
				pageTabsEl.innerHTML = "";
				pagePanelsEl.innerHTML = "";
				pageEmpty.querySelector("span").textContent = message;
				pageEmpty.style.display = "flex";
			}

			let currentPayload = null;

			function truncate(text, len = 120) {
				if (!text) return "";
				return text.length > len ? text.slice(0, len) + "…" : text;
			}

			function computePageText(page) {
				const exclude = page._removed || new Set();
				const lines = [];
				page.blocks.forEach((block) => {
					if (exclude.has(block.id)) return;
					const txt = block.text || "";
					if (!txt.trim()) return;
					if (block.type === "table-cell") {
						lines.push(`[Table r${block.row} c${block.col}] ${txt}`);
					} else {
						lines.push(txt);
					}
				});
				return lines.join("\n");
			}

			function recomputePageText(page) {
				const pre = document.getElementById(`text-page-${page.page}`);
				const text = computePageText(page);
				pre.textContent = text || "テキスト抽出なし";
			}

			function recomputeAllText() {
				if (!currentPayload) return;
				const lines = [];
				currentPayload.results.forEach((page) => {
					const text = computePageText(page);
					if (text) {
						lines.push(`--- Page ${page.page} ---`);
						lines.push(text);
					}
				});
				textAllEl.textContent = lines.join("\n\n") || "テキスト抽出なし";
			}

			function renderBlockList(page) {
				const container = document.getElementById(`blocks-${page.page}`);
				if (!container) return;
				container.innerHTML = page.blocks
					.map(
						(block) => `
              <label class="block-item">
                <input type="checkbox" data-block-id="${block.id}" />
                <div>
                  <div><strong>${block.type}</strong></div>
                  <div class="block-meta">${truncate(block.text || "(テキストなし)", 140)}</div>
                </div>
              </label>
            `
					)
					.join("");

				container.addEventListener("change", (event) => {
					const target = event.target;
					if (!target.matches("input[type='checkbox'][data-block-id]")) return;

					const id = target.getAttribute("data-block-id");
					page._removed = page._removed || new Set();
					if (target.checked) {
						page._removed.add(id);
					} else {
						page._removed.delete(id);
					}
					recomputePageText(page);
					recomputeAllText();
				});
			}

			function renderResults(payload) {
				if (!payload || !payload.results || !payload.results.length) {
					resetResults("結果がありません。");
					return;
				}

				currentPayload = payload;

				summaryEmpty.style.display = "none";
				summaryEl.innerHTML = [
					`デバイス: ${payload.device}`,
					`ONNX: ${payload.use_onnx ? "ON" : "OFF"}`,
					`Threads: ${payload.torch_threads}`,
					`並列: ${payload.parallelism}`,
					`Pages: ${payload.page_count}`,
					`改行: ${payload.collapse_line_breaks ? "削除" : "保持"}`,
				]
					.map((text) => `<span class="chip">${text}</span>`)
					.join("");

				const tabs = payload.results
					.map(
						(page, idx) =>
							`<button class="tab ${idx === 0 ? "active" : ""}" data-target="panel-${page.page}">Page ${page.page}</button>`
					)
					.join("");

				const panels = payload.results
					.map((page, idx) => {
						const ocrImg = page.ocr_preview
							? `<img src="data:image/jpeg;base64,${page.ocr_preview}" alt="OCR overlay" />`
							: "";
						const layoutImg = page.layout_preview
							? `<img src="data:image/jpeg;base64,${page.layout_preview}" alt="Layout overlay" />`
							: "";

						return `
              <div class="tab-panel ${idx === 0 ? "active" : ""}" id="panel-${page.page}">
                <div class="result-card">
                  <h3>Page ${page.page}</h3>
                  <div class="badge-row">
                    <span class="chip">Paragraphs: ${page.summary.paragraphs}</span>
                    <span class="chip">Tables: ${page.summary.tables}</span>
                    <span class="chip">Figures: ${page.summary.figures}</span>
                    <span class="chip">Words: ${page.summary.words}</span>
                  </div>
                  <pre id="text-page-${page.page}">${page.text || "テキスト抽出なし"}</pre>
                  <div class="preview-row">
                    ${ocrImg}
                    ${layoutImg}
                  </div>
                  <p class="muted" style="margin: 10px 0 4px; font-size: 12px;">不要なブロックを除外してテキストを再生成できます。</p>
                  <div class="block-list" id="blocks-${page.page}"></div>
                </div>
              </div>
            `;
					})
					.join("");

				pageTabsEl.innerHTML = tabs;
				pagePanelsEl.innerHTML = panels;
				pageEmpty.style.display = "none";
				allTextCard.style.display = "block";

				payload.results.forEach((page) => {
					page._removed = new Set();
					renderBlockList(page);
					recomputePageText(page);
				});

				recomputeAllText();

				const tabButtons = pageTabsEl.querySelectorAll(".tab");
				const tabPanels = pagePanelsEl.querySelectorAll(".tab-panel");
				const setActive = (targetId) => {
					tabButtons.forEach((btn) => {
						btn.classList.toggle("active", btn.getAttribute("data-target") === targetId);
					});
					tabPanels.forEach((panel) => {
						panel.classList.toggle("active", panel.id === targetId);
					});
				};
				tabButtons.forEach((btn) => {
					btn.addEventListener("click", () => setActive(btn.getAttribute("data-target")));
				});
			}

			function openLightbox(src) {
				if (!src) return;
				lightboxImg.src = src;
				lightbox.classList.add("open");
			}

			function closeLightbox() {
				lightbox.classList.remove("open");
				lightboxImg.removeAttribute("src");
			}

			form.addEventListener("submit", async (event) => {
				event.preventDefault();
				if (!fileInput.files.length) {
					alert("ファイルを選択してください。");
					return;
				}

				const formData = new FormData();
				formData.append("file", fileInput.files[0]);
				formData.append("device", "auto");
				formData.append("use_onnx", false);
				formData.append("visualize", document.getElementById("visualize").checked);
				formData.append("collapse_line_breaks", collapseBreaksInput.checked);
				formData.append("parallelism", 2);
				formData.append("torch_threads", 8);
				formData.append("dpi", 220);

				setBusy(true, "推論ジョブを投入しています...");
				resetResults("処理中です。少しお待ちください。");

				try {
					const res = await fetch("/api/analyze", {
						method: "POST",
						body: formData,
					});

					if (!res.ok) {
						const err = await res.json().catch(() => ({}));
						throw new Error(err.detail || "推論リクエストに失敗しました。");
					}

					const data = await res.json();
					renderResults(data);
					setBusy(false, "完了");
				} catch (err) {
					console.error(err);
					resetResults(`エラー: ${err.message}`);
					setBusy(false, "エラー");
				}
			});

			pagePanelsEl.addEventListener("click", (event) => {
				const img = event.target.closest(".preview-row img");
				if (img) {
					openLightbox(img.src);
				}
			});

			lightbox.addEventListener("click", closeLightbox);
			document.addEventListener("keydown", (event) => {
				if (event.key === "Escape") {
					closeLightbox();
				}
			});

			["dragenter", "dragover"].forEach((evt) => {
				dropzone.addEventListener(evt, (event) => {
					event.preventDefault();
					event.stopPropagation();
					dropzone.classList.add("dragover");
				});
			});

			["dragleave", "drop"].forEach((evt) => {
				dropzone.addEventListener(evt, (event) => {
					event.preventDefault();
					event.stopPropagation();
					dropzone.classList.remove("dragover");
				});
			});

			dropzone.addEventListener("drop", (event) => {
				const files = event.dataTransfer?.files;
				if (files && files.length) {
					fileInput.files = files;
					logEl.textContent = files[0].name;
				}
			});

			dropzone.addEventListener("click", () => fileInput.click());
			fileInput.addEventListener("change", () => {
				if (fileInput.files.length) {
					logEl.textContent = fileInput.files[0].name;
				}
			});

			resetResults();
			refreshStatus();
		</script>
	</body>
</html>
